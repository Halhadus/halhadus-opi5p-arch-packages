CONFIG="--disable-vapoursynth --disable-doc"
eval "$(curl -s -L https://raw.githubusercontent.com/hbiyik/agrrepo/refs/heads/master/libinherit/remote.sh)"
inherit https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/extra/ffmpeg/

_pkgname=ffmpeg
pkgname=ffmpeg-v4l2-request
arch=('aarch64')
conflicts+=("ffmpeg")
provides+=("ffmpeg")
replaces+=("ffmpeg-v4l2-request")

source=("${source[@]//git.ffmpeg.org\/ffmpeg.git/github.com\/FFmpeg\/FFmpeg.git}")
source+=("v4l2request.diff::https://code.ffmpeg.org/FFmpeg/FFmpeg/pulls/20847.diff")
b2sums+=('SKIP')

pkgver() {
  cd ffmpeg
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "$_pkgname"
  cd "$srcdir"
  pkgname=$_pkgname
  old_prepare
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../v4l2request.diff
  pkgname=ffmpeg-v4l2-request
}

build() {
  pkgname=$_pkgname
  old_build
  pkgname=ffmpeg-v4l2-request
}

package() {
  pkgname=$_pkgname
  old_package
  pkgname=ffmpeg-v4l2-request
}
