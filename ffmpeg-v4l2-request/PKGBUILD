CONFIG="--disable-vapoursynth --disable-doc --enable-v4l2-request --enable-libudev --enable-v4l2_m2m --enable-libdrm --enable-neon --enable-hwaccels"
eval "$(curl -s -L https://raw.githubusercontent.com/hbiyik/agrrepo/refs/heads/master/libinherit/remote.sh)"
inherit https://raw.githubusercontent.com/archlinuxarm/PKGBUILDs/master/extra/ffmpeg/

_pkgname=ffmpeg
pkgname=ffmpeg-v4l2-request
arch=('aarch64')
conflicts+=("ffmpeg")
provides+=("ffmpeg")
replaces+=("ffmpeg-v4l2-request")

source=("${source[@]//git+https:\/\/git.ffmpeg.org\/ffmpeg.git/ffmpeg::git+https:\/\/github.com\/FFmpeg\/FFmpeg.git}")
source+=("v4l2request.diff::https://code.ffmpeg.org/FFmpeg/FFmpeg/compare/master...Kwiboo:v4l2request-2025-v3-rkvdec.diff")
source+=("strps1.patch::https://gitlab.collabora.com/detlev/ffmpeg/-/commit/20b37c99b9318e1b104aa11f2569fcb0c7387e1e.patch")
source+=("strps2.patch::https://gitlab.collabora.com/detlev/ffmpeg/-/commit/dfa10f6e10441aef0d8b45c97bf3bce6598ede48.patch")
source+=("drmprime.patch::https://github.com/LibreELEC/LibreELEC.tv/raw/refs/heads/master/packages/multimedia/ffmpeg/patches/v4l2-drmprime/ffmpeg-001-v4l2-drmprime.patch")
source+=("deinterlace.patch::https://github.com/LibreELEC/LibreELEC.tv/raw/refs/heads/master/packages/multimedia/ffmpeg/patches/vf-deinterlace-v4l2m2m/ffmpeg-001-vf-deinterlace-v4l2m2m.patch")
b2sums+=('SKIP')
b2sums+=('SKIP')
b2sums+=('SKIP')
b2sums+=('SKIP')
b2sums+=('SKIP')

pkgver() {
  cd ffmpeg
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "$_pkgname"
  cd "$srcdir"
  pkgname=$_pkgname
  old_prepare
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../v4l2request.diff
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../strps1.patch
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../strps2.patch
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../drmprime.patch
  git apply -3 --exclude='.forgejo/CODEOWNERS' ../deinterlace.patch
  pkgname=ffmpeg-v4l2-request
}

build() {
  pkgname=$_pkgname
  local KHEADERS_DIR="$srcdir/../kheaders"
  export CFLAGS="-I$KHEADERS_DIR -I$KHEADERS_DIR/include -I$KHEADERS_DIR/include/uapi $CFLAGS"
  export CXXFLAGS="-I$KHEADERS_DIR -I$KHEADERS_DIR/include -I$KHEADERS_DIR/include/uapi $CXXFLAGS"
  old_build
  pkgname=ffmpeg-v4l2-request
}

package() {
  pkgname=$_pkgname
  old_package
  pkgname=ffmpeg-v4l2-request
}
