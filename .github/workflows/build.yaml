name: Rockchip Mainline Package Builder

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build in Arch Container
        run: |
          mkdir -p artifacts
          docker run --rm --privileged -v ${{ github.workspace }}:/workspace -w /workspace agners/archlinuxarm:latest /bin/bash -c "
            pacman-key --init && pacman-key --populate archlinuxarm
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed base-devel git cmake curl zip sudo mesa libglvnd pipewire-jack python-setuptools python-mako vulkan-devel wayland-protocols
            useradd -m builder
            echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /workspace
            sed -i 's/#MAKEFLAGS=\"-j2\"/MAKEFLAGS=\"-j4\"/' /etc/makepkg.conf
            PKGS=(
              "ffmpeg-v4l2-request"
              "mpv-v4l2-request"
              "wayfire-plugins-extra-aarch64"
              "linux-collabora-rockchip-devel"
              "glfw-wayland-minecraft-cursorfix-aarch64"
              "mangohud-aarch64"
              "nvtop-panthor"
              "wlrctl-aarch64"
            )
            for pkg_dir in \"\${PKGS[@]}\"; do
              if [ -d \"\$pkg_dir\" ]; then
                echo \"Building: \$pkg_dir\"
                cd \"/workspace/\$pkg_dir\"
                sudo -u builder makepkg -sc --noconfirm --needed || { echo \"FAILED: \$pkg_dir\"; continue; }
                pacman -U --noconfirm *.pkg.tar.zst
                cp -v *.pkg.tar.zst /workspace/artifacts/ 2>/dev/null
                cd /workspace
              fi
            done            
            chmod -R 777 /workspace/artifacts
          "

      - name: Zip Artifacts
        run: |
          if [ -d "artifacts" ] && [ "$(ls -A artifacts)" ]; then
            cd artifacts && zip ../packages.zip *.pkg.tar.zst
          else
            echo "No packages found to zip!"
            exit 1
          fi

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: aarch64-repo-bundle
          path: packages.zip
