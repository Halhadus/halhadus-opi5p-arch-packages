name: Rockchip Mainline Package Builder

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build in Arch Container
        run: |
          mkdir -p ${{ github.workspace }}/artifacts
          chmod -R 777 ${{ github.workspace }}/artifacts
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            agners/archlinuxarm:latest /bin/bash -c "
            pacman-key --init && pacman-key --populate archlinuxarm
            pacman -Syu --noconfirm --needed base-devel git cmake curl zip sudo mesa libglvnd pipewire-jack            
            useradd -m builder
            echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /workspace
            PKGS=(
              \"ffmpeg-v4l2-request\"
              \"mpv-v4l2-request\"
              \"wayfire-plugins-extra-aarch64\"
              \"glfw-wayland-minecraft-cursorfix-aarch64\"
              \"mangohud-aarch64\"
              \"nvtop-panthor\"
              \"wlrctl-aarch64\"
            )
            for pkg_dir in \"\${PKGS[@]}\"; do
              if [ -d \"\$pkg_dir\" ]; then
                echo \">>> BUILDING: \$pkg_dir\"
                cd \"/workspace/\$pkg_dir\"
                sudo -u builder makepkg -sc --noconfirm --needed || { echo \"FAILED: \$pkg_dir\"; continue; }
                for f in \$(ls *.pkg.tar.zst 2>/dev/null); do
                  echo \"Copying \$f to artifacts...\"
                  cp -v \"\$f\" /workspace/artifacts/
                  pacman -U --noconfirm \"\$f\"
                done                
                cd /workspace
              fi
            done
          "

      - name: Zip Artifacts
        run: |
          ls -lh artifacts/          
          if [ -n "$(ls -A artifacts/*.pkg.tar.zst 2>/dev/null)" ]; then
            cd artifacts && zip ../packages.zip *.pkg.tar.zst
          else
            echo "No artifact"
            exit 1
          fi

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: aarch64-repo-bundle
          path: packages.zip
